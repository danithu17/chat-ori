<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Vault Pro - God Mode Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        :root {
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --bg-dark: #020617;
            --panel-bg: rgba(15, 23, 42, 0.7);
            --admin-gold: #fbbf24;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: radial-gradient(circle at top right, #1e1b4b, #020617, #020617);
            color: #f8fafc; 
            height: 100vh;
            overflow: hidden;
            margin: 0;
        }

        h1, h2, h3, .font-space { font-family: 'Space Grotesk', sans-serif; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: rgba(99, 102, 241, 0.3); 
            border-radius: 20px; 
        }

        .glass {
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .admin-glass {
            background: rgba(251, 191, 36, 0.05);
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .neo-button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .neo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px var(--accent-glow);
        }

        .message-bubble { 
            max-width: 85%; 
            padding: 12px 18px;
            animation: slideUp 0.3s ease-out;
            border-radius: 1.5rem;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .channel-btn {
            width: 100%; padding: 10px 14px; border-radius: 12px;
            font-size: 13px; color: #94a3b8; transition: all 0.2s;
            display: flex; align-items: center; gap: 10px;
        }
        
        .channel-btn.active { 
            background: rgba(99, 102, 241, 0.1); 
            color: #a5b4fc; 
            box-shadow: inset 0 0 15px rgba(99, 102, 241, 0.1);
        }

        .modal-overlay {
            display: none; position: fixed; inset: 0; z-index: 200;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);
            align-items: center; justify-content: center;
        }

        #sidebar { transition: transform 0.3s ease; }

        @media (max-width: 768px) {
            #sidebar { position: fixed; left: -100%; top: 0; bottom: 0; z-index: 150; width: 280px; }
            #sidebar.active { transform: translateX(100%); }
        }

        .img-preview {
            max-width: 250px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
        }
        
        .admin-tag {
            font-size: 8px;
            padding: 2px 6px;
            background: var(--admin-gold);
            color: black;
            border-radius: 4px;
            font-weight: 900;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="flex">

    <!-- Loader -->
    <div id="initLoader" class="fixed inset-0 z-[1000] bg-slate-950 flex flex-col items-center justify-center">
        <div class="relative w-16 h-16">
            <div class="absolute inset-0 border-4 border-indigo-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <p class="mt-6 text-indigo-400 text-[10px] tracking-[0.4em] uppercase font-bold animate-pulse">Ghost Protocol Active</p>
    </div>

    <!-- Auth Overlay -->
    <div id="loginOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-950 px-4">
        <div class="w-full max-w-sm glass p-10 rounded-[2.5rem] border-white/5 shadow-2xl">
            <div class="flex flex-col items-center mb-10">
                <div class="w-16 h-16 rounded-2xl bg-indigo-600 flex items-center justify-center mb-6 shadow-indigo-500/30">
                    <i data-lucide="ghost" class="text-white w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-black text-white uppercase tracking-tighter font-space">Vault Access</h2>
                <p class="text-[9px] text-slate-500 mt-2 uppercase tracking-[0.2em]">Secure Encryption Active</p>
            </div>
            
            <div class="space-y-4">
                <input type="text" id="authUsername" placeholder="Identity" class="w-full bg-slate-900 border border-white/10 rounded-2xl px-5 py-4 outline-none focus:border-indigo-500 text-sm">
                <input type="password" id="authPassword" placeholder="Passkey" class="w-full bg-slate-900 border border-white/10 rounded-2xl px-5 py-4 outline-none focus:border-indigo-500 text-sm">
                <button id="authBtn" class="w-full bg-indigo-600 py-4 rounded-2xl font-black text-xs uppercase tracking-widest neo-button">Establish Link</button>
                <p class="text-[10px] text-center text-slate-500 cursor-pointer hover:text-indigo-400 transition" id="toggleAuthMode">New here? Create Terminal</p>
            </div>
        </div>
    </div>

    <!-- App Shell -->
    <div id="appUI" class="hidden flex w-full h-screen">
        <aside id="sidebar" class="bg-slate-950 border-r border-white/5 flex flex-col md:w-72 shrink-0">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <span class="text-[10px] font-black uppercase tracking-widest text-indigo-500">Channels</span>
                <button onclick="openModal('createNodeModal')" class="text-slate-500 hover:text-white"><i data-lucide="plus" class="w-4 h-4"></i></button>
            </div>
            
            <div class="flex-grow overflow-y-auto px-4 py-4 custom-scrollbar">
                <!-- Admin Control -->
                <div id="adminMenu" class="hidden mb-6">
                    <p class="text-[9px] uppercase tracking-widest text-amber-500 mb-2 px-4 font-black">Control Room</p>
                    <button onclick="openModal('godModeModal')" class="channel-btn bg-amber-500/10 text-amber-500 hover:bg-amber-500/20">
                        <i data-lucide="shield-alert"></i> GOD MODE
                    </button>
                </div>

                <div id="groupList" class="space-y-1 mb-8"></div>
                <div id="userList" class="space-y-1"></div>
            </div>

            <!-- Current User Profile -->
            <div class="p-6 border-t border-white/5 bg-slate-900/30">
                <div class="flex items-center gap-3">
                    <div id="userAvatar" class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center text-xs font-black uppercase relative">
                        ?
                        <div id="adminIndicator" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-amber-500 rounded-full border-2 border-slate-900"></div>
                    </div>
                    <div class="flex-grow overflow-hidden">
                        <div class="flex items-center gap-2">
                            <p id="headerName" class="text-xs font-bold text-white truncate"></p>
                            <span id="adminBadge" class="hidden admin-tag">Admin</span>
                        </div>
                        <p class="text-[8px] text-emerald-500 font-bold uppercase tracking-widest">Connected</p>
                    </div>
                    <button id="logoutBtn" class="text-slate-500 hover:text-red-500 transition"><i data-lucide="power" class="w-4 h-4"></i></button>
                </div>
            </div>
        </aside>

        <main class="flex-grow flex flex-col min-w-0 bg-slate-950/50">
            <header class="h-16 border-b border-white/5 px-6 flex items-center justify-between glass shrink-0">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-400"><i data-lucide="menu" class="w-5 h-5"></i></button>
                    <h3 id="currentChannelName" class="font-black text-sm uppercase font-space tracking-tight">Public</h3>
                </div>
                <div id="adminBanner" class="hidden px-3 py-1 bg-amber-500/10 border border-amber-500/20 rounded-full text-[9px] font-black text-amber-500 tracking-tighter animate-pulse">
                    GOD MODE ACTIVE
                </div>
            </header>
            
            <div id="chatWindow" class="flex-grow overflow-y-auto p-6 md:p-8 flex flex-col gap-6 custom-scrollbar"></div>
            
            <footer class="p-6 shrink-0">
                <div class="flex gap-3 bg-slate-900/50 border border-white/10 p-2 pl-5 rounded-2xl glass">
                    <input type="text" id="messageInput" placeholder="Message..." class="flex-grow bg-transparent outline-none text-sm py-2 text-white">
                    <input type="file" id="fileInput" class="hidden" accept="image/*">
                    <button onclick="document.getElementById('fileInput').click()" class="p-2 text-slate-500 hover:text-indigo-400 transition">
                        <i data-lucide="image" class="w-5 h-5"></i>
                    </button>
                    <button id="sendBtn" class="bg-indigo-600 text-white w-10 h-10 rounded-xl flex items-center justify-center neo-button">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
            </footer>
        </main>
    </div>

    <!-- Modals -->
    <div id="createNodeModal" class="modal-overlay">
        <div class="bg-slate-900 border border-white/10 p-8 rounded-3xl w-full max-w-xs glass">
            <h3 class="text-white font-black mb-6 uppercase text-[10px] tracking-widest text-center">New Channel</h3>
            <input type="text" id="newGroupNameInput" placeholder="Channel Name" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-sm mb-4 outline-none">
            <div class="flex gap-3">
                <button onclick="closeModal('createNodeModal')" class="flex-1 text-[10px] font-bold text-slate-500">Cancel</button>
                <button id="confirmCreateBtn" class="flex-1 bg-indigo-600 py-3 rounded-xl text-[10px] font-bold">Create</button>
            </div>
        </div>
    </div>

    <!-- God Mode Modal -->
    <div id="godModeModal" class="modal-overlay">
        <div class="bg-slate-900 border border-amber-500/20 p-8 rounded-[2.5rem] w-full max-w-lg glass admin-glass overflow-hidden flex flex-col max-h-[80vh]">
            <div class="flex items-center gap-4 mb-8">
                <div class="w-12 h-12 rounded-2xl bg-amber-500 flex items-center justify-center shadow-lg shadow-amber-500/20">
                    <i data-lucide="shield-check" class="text-black w-6 h-6"></i>
                </div>
                <div>
                    <h3 class="text-amber-500 font-black uppercase text-lg tracking-tighter font-space">God Mode Dashboard</h3>
                    <p class="text-[10px] text-slate-500 font-bold tracking-widest uppercase">Vault Administration</p>
                </div>
                <button onclick="closeModal('godModeModal')" class="ml-auto text-slate-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="flex-grow overflow-y-auto custom-scrollbar">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-[10px] text-slate-500 uppercase font-black border-b border-white/5">
                            <th class="py-4 px-2">Terminal</th>
                            <th class="py-4 px-2">Status</th>
                            <th class="py-4 px-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminUserTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQ4kbOR1uvonh3QQyPtglAKf02jnxNxTo",
            authDomain: "chat123-8b002.firebaseapp.com",
            projectId: "chat123-8b002",
            storageBucket: "chat123-8b002.firebasestorage.app",
            messagingSenderId: "949955284458",
            appId: "1:949955284458:web:9feca2b883fc5dd43c3693"
        };

        const appId = 'ghost-vault-pro-v3';
        const CRYPTO_KEY = "SECRET_PROTOCOL_X";
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null, currentTarget = 'Public', isDM = false, msgUnsub = null, isAdmin = false;

        const encrypt = (t) => CryptoJS.AES.encrypt(t, CRYPTO_KEY).toString();
        const decrypt = (h) => {
            try { return CryptoJS.AES.decrypt(h, CRYPTO_KEY).toString(CryptoJS.enc.Utf8) || "[Encrypted]"; }
            catch { return "[Encrypted Content]"; }
        };

        // --- AUTH ---
        window.logout = async () => {
            if (currentUser) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser), { isOnline: false });
            }
            localStorage.removeItem('vault_session');
            await signOut(auth);
            location.reload();
        };

        // UI Helpers to avoid null reference errors
        const safeClassList = (id, method, className) => {
            const el = document.getElementById(id);
            if (el) el.classList[method](className);
        };

        const setUIContent = (id, content) => {
            const el = document.getElementById(id);
            if (el) el.innerText = content;
        };

        const setUIDisplay = (id, display) => {
            const el = document.getElementById(id);
            if (el) el.style.display = display;
        };

        const startApp = async (userData) => {
            currentUser = userData.username;
            isAdmin = userData.role === 'admin';
            
            localStorage.setItem('vault_session', JSON.stringify({ name: currentUser, role: userData.role }));
            
            // Fixed null checks for classList and style
            safeClassList('loginOverlay', 'add', 'hidden');
            safeClassList('appUI', 'remove', 'hidden');
            setUIDisplay('initLoader', 'none');
            
            setUIContent('headerName', currentUser);
            setUIContent('userAvatar', currentUser[0]);
            
            if(isAdmin) {
                safeClassList('adminMenu', 'remove', 'hidden');
                safeClassList('adminBadge', 'remove', 'hidden');
                safeClassList('adminIndicator', 'remove', 'hidden');
                safeClassList('adminBanner', 'remove', 'hidden');
            }

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser), { isOnline: true });
            } catch (e) { console.error("Status update failed:", e); }
            
            loadSidebar();
            loadMessages();
            if(isAdmin) loadAdminPanel();
            lucide.createIcons();
        };

        // Run after DOM is fully loaded to prevent null references
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('logoutBtn').onclick = window.logout;
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const session = JSON.parse(localStorage.getItem('vault_session'));
                    if (session) {
                        const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', session.name));
                        if (snap.exists() && !snap.data().isBanned) startApp(snap.data());
                        else { 
                            safeClassList('loginOverlay', 'remove', 'hidden'); 
                            setUIDisplay('initLoader', 'none'); 
                        }
                    } else { 
                        safeClassList('loginOverlay', 'remove', 'hidden'); 
                        setUIDisplay('initLoader', 'none'); 
                    }
                } else { await signInAnonymously(auth); }
            });

            // Re-bind actions that depend on DOM
            document.getElementById('sendBtn').onclick = () => sendMessage('text');
            document.getElementById('messageInput').onkeypress = (e) => e.key === 'Enter' && sendMessage('text');
            document.getElementById('authBtn').onclick = handleAuth;
            document.getElementById('toggleAuthMode').onclick = toggleAuthMode;
            document.getElementById('confirmCreateBtn').onclick = createGroup;
            
            document.getElementById('fileInput').onchange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => sendMessage('image', ev.target.result);
                    reader.readAsDataURL(file);
                }
            };
        });

        // --- SIDEBAR ---
        function loadSidebar() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), snap => {
                const list = document.getElementById('groupList');
                if(!list) return;
                list.innerHTML = `<button class="channel-btn ${!isDM && currentTarget==='Public'?'active':''}" onclick="switchChat('Public', false)"><i data-lucide="hash"></i> Public</button>`;
                snap.forEach(d => {
                    const g = d.data();
                    list.innerHTML += `<button class="channel-btn ${!isDM && currentTarget===g.name?'active':''}" onclick="switchChat('${g.name}', false)"><i data-lucide="hash"></i> ${g.name}</button>`;
                });
                lucide.createIcons();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), snap => {
                const list = document.getElementById('userList');
                if(!list) return;
                list.innerHTML = `<p class="text-[9px] uppercase tracking-widest text-slate-600 mb-4 px-4 font-bold">Terminals</p>`;
                snap.forEach(d => {
                    const u = d.data();
                    if(u.username === currentUser) return;
                    if(u.isBanned && !isAdmin) return; 
                    
                    list.innerHTML += `<button class="channel-btn ${isDM && currentTarget===u.username?'active':''}" onclick="switchChat('${u.username}', true)">
                        <span class="w-2 h-2 rounded-full ${u.isBanned ? 'bg-red-500' : (u.isOnline?'bg-emerald-500':'bg-slate-700')}"></span>
                        <span class="truncate ${u.isBanned ? 'line-through opacity-50':''}">${u.username}</span>
                        ${u.role === 'admin' ? '<span class="admin-tag ml-auto">Admin</span>' : ''}
                    </button>`;
                });
            });
        }

        // --- MESSAGES ---
        function loadMessages() {
            if(msgUnsub) msgUnsub();
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), orderBy('timestamp', 'asc'));
            msgUnsub = onSnapshot(q, snap => {
                const win = document.getElementById('chatWindow');
                if(!win) return;
                win.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    const show = isDM ? (m.isPrivate && ((m.user === currentUser && m.target === currentTarget) || (m.user === currentTarget && m.target === currentUser))) : (!m.isPrivate && m.groupId === currentTarget);
                    if(show) {
                        const isMe = m.user === currentUser;
                        const msgDiv = document.createElement('div');
                        msgDiv.className = `flex flex-col ${isMe?'items-end':'items-start'} mb-2 group`;
                        
                        let content = `<div class="message-bubble ${isMe?'bg-indigo-600 text-white':'bg-slate-900 text-slate-300 border border-white/5'} ${isAdmin ? 'hover:border-amber-500/50 cursor-pointer transition' : ''}">`;
                        if(m.type === 'image') content += `<img src="${m.imageData}" class="img-preview" onclick="window.open('${m.imageData}')">`;
                        else content += `<p class="text-sm">${decrypt(m.text)}</p>`;
                        
                        content += `<span class="text-[8px] opacity-40 mt-1 block uppercase font-bold">${m.user}</span></div>`;
                        msgDiv.innerHTML = content;
                        
                        if(isMe || isAdmin) {
                            msgDiv.oncontextmenu = (e) => {
                                e.preventDefault();
                                const confirmText = isAdmin && !isMe ? `GOD MODE: Purge message from ${m.user}?` : "Purge message?";
                                if(confirm(confirmText)) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'messages', d.id));
                            };
                        }
                        win.appendChild(msgDiv);
                    }
                });
                win.scrollTop = win.scrollHeight;
            }, (err) => console.error("Firestore error:", err));
        }

        // --- ADMIN PANEL ---
        function loadAdminPanel() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), snap => {
                const table = document.getElementById('adminUserTable');
                if(!table) return;
                table.innerHTML = '';
                snap.forEach(d => {
                    const u = d.data();
                    if(u.username === currentUser) return;
                    
                    const row = document.createElement('tr');
                    row.className = "border-b border-white/5 hover:bg-white/5 transition";
                    row.innerHTML = `
                        <td class="py-4 px-2">
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-white">${u.username}</span>
                                <span class="text-[8px] text-slate-500 uppercase">${u.role}</span>
                            </div>
                        </td>
                        <td class="py-4 px-2">
                            <span class="text-[9px] px-2 py-1 rounded ${u.isBanned ? 'bg-red-500/10 text-red-500' : 'bg-emerald-500/10 text-emerald-500'} font-black uppercase">
                                ${u.isBanned ? 'Exiled' : 'Auth'}
                            </span>
                        </td>
                        <td class="py-4 px-2">
                            <button onclick="window.toggleBan('${u.username}', ${u.isBanned})" class="text-[10px] font-black uppercase px-3 py-2 rounded-lg ${u.isBanned ? 'bg-emerald-600 text-white' : 'bg-red-600/20 text-red-500 hover:bg-red-600 hover:text-white'} transition">
                                ${u.isBanned ? 'Pardon' : 'Exile'}
                            </button>
                        </td>
                    `;
                    table.appendChild(row);
                });
            });
        }

        window.toggleBan = async (username, currentStatus) => {
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', username);
            await updateDoc(userRef, { isBanned: !currentStatus });
        };

        // --- ACTIONS ---
        window.switchChat = (target, dm) => {
            currentTarget = target; isDM = dm;
            setUIContent('currentChannelName', target);
            loadMessages();
            if (window.innerWidth <= 768) toggleSidebar();
        };

        window.toggleSidebar = () => safeClassList('sidebar', 'toggle', 'active');
        window.openModal = (id) => setUIDisplay(id, 'flex');
        window.closeModal = (id) => setUIDisplay(id, 'none');

        const sendMessage = async (type = 'text', data = null) => {
            const msgData = { 
                user: currentUser, 
                timestamp: serverTimestamp(), 
                isPrivate: isDM,
                type: type
            };
            if(isDM) msgData.target = currentTarget; else msgData.groupId = currentTarget;
            
            if(type === 'text') {
                const input = document.getElementById('messageInput');
                if(!input || !input.value.trim()) return;
                msgData.text = encrypt(input.value.trim());
                input.value = '';
            } else { msgData.imageData = data; }

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), msgData);
        };

        async function handleAuth() {
            const user = document.getElementById('authUsername').value.trim();
            const pass = document.getElementById('authPassword').value.trim();
            if(!user || !pass) return;

            if(user === 'admin' && pass === '123') {
                const adminData = { username: 'admin', role: 'admin', isBanned: false, isOnline: true };
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', 'admin');
                await setDoc(userRef, adminData, { merge: true });
                startApp(adminData);
                return;
            }

            const isRegister = document.getElementById('toggleAuthMode').innerText.includes('Create');
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user);
            const snap = await getDoc(userRef);

            if (isRegister) {
                if(snap.exists()) return alert("Identity already exists.");
                const newUser = { username: user, password: pass, role: 'user', isBanned: false, isOnline: true };
                await setDoc(userRef, newUser);
                startApp(newUser);
            } else {
                if(snap.exists() && snap.data().password === pass) {
                    if(snap.data().isBanned) return alert("Terminal Exile: Access Denied.");
                    startApp(snap.data());
                } else alert("Access Denied.");
            }
        }

        function toggleAuthMode() {
            const isLogin = this.innerText.includes('Create');
            this.innerText = isLogin ? "Already have terminal? Login" : "New here? Create Terminal";
            document.getElementById('authBtn').innerText = isLogin ? "Initialize Terminal" : "Establish Link";
        }

        async function createGroup() {
            const nameInput = document.getElementById('newGroupNameInput');
            const name = nameInput.value.trim();
            if(!name) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), { name });
            closeModal('createNodeModal');
            nameInput.value = '';
        }

        lucide.createIcons();
    </script>
</body>
</html>
